<% if !@paying %>
  <script>
  $(function(){
    $('#new-order').submit(function(){
      match = $('#order-email').val().match(/\S+@\S+\.[a-zA-Z]{2,}$/);

      if(!match) {
        $('#payment-errors').text("Please enter an email address.");
        return false;
      }
    });
  });
  </script>
<% end %>

<form id="new-order" method="post" action="/purchase" <% if !@paying %>class="centered"<% end %> >
  <h3>
    The Nature of Code PDF
    <div id="display-amount"><strong>$<%= "%.2f" % [@amount] %></strong></div>
    <% if @paying %>
    <div id="donation">
      $<%= "%.2f" % [@amount.to_f * @donation.to_i/100.0] %> of purchase will be donated to Processing
    </div>
    <% end %>
  </h3>

  <div id="payment-errors"></div>

  <% if @paying %>
  <input type="hidden" id="order-stripe-card-token" name="order[token]">
  <input type=hidden name=order[amount] id=order-amount value="<%= @amount %>">
  <input type=hidden name=order[donation] value="<%= @donation %>">
  <% else %>
    <input type=hidden name=order[free] value="true">
  <% end %>

  <div class="field">
    <label for="order-email">Email Address</label>
    <input type="email" name="order[email]" id="order-email">
  </div>

  <div class="field">
    <label for="order-first-name">First Name</label>
    <input type="text" name="order[first_name]" id="order-first-name">
  </div>

  <div class="field">
    <label for="order-last-name">Last Name</label>
    <input type="text" name="order[last_name]" id="order-last-name">
  </div>

  <input type="checkbox" name="order[paypal]" id="paypal-toggle">

  <% if @paying %>
  <div id="stripe-info">
    <div class="field">
      <label for="card-number">Credit Card Number</label>
      <input type="text" size=20 autocomplete=off id="card-number">
    </div>

    <div class="field">
      <label for="card-code">Security Code (CVV)</label>
      <input type="text" size=4 autocomplete=off id="card-code">
    </div>

    <div class="field">
      <label for="card-month">Card Expiration</label>
      <fieldset>
        <select id="card-month">
          <option>MM</option>
          <% 1.upto(12) do |i| %>
          <option><%= i %></option>
          <% end %>
        </select>
        <select id="card-year">
          <option>YYYY</option>
          <% year = Date.today.year %>
          <% 16.times do |i| %>
          <option><%= year + i %></option>
          <% end %>
        </select>
      </fieldset>
    </div>

    <div id="stripe_error">
      <noscript>JavaScript is not enabled and is required for this form. First enable it in your web browser settings.</noscript>
    </div>
  </div>
  <% end %>

  <p>You will receive an email with a link to download the book after purchase.</p>

  <button type="submit" class="submit-button">Complete Purchase</button>

  <p class="caveat">(If you've stumbled your way here, you are viewing a "preview" of my book purchasing site. You can buy an advance draft of the book here and you will receive updates as I make revisions and publish the finished version.)</a>

</form>

<% if @paying %>
<div id="order-info">
  <p>Upon successful payment you will receive an email with a link to download your PDF.</p>

  <p>Payments handled securely with <a href="http://stripe.com">Stripe</a>.  PDF delivered via <a href="http://www.fetchapp.com/">FetchApp</a>.</p>
</div>
<% end %>